!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.XStateGraph={})}(this,function(t){"use strict";var e=function(){return(e=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function n(t,e){var n={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(n[r]=t[r]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(t);i<r.length;i++)e.indexOf(r[i])<0&&(n[r[i]]=t[r[i]])}return n}function r(t){var e="function"==typeof Symbol&&t[Symbol.iterator],n=0;return e?e.call(t):{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}}}function i(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var r,i,o=n.call(t),a=[];try{for(;(void 0===e||e-- >0)&&!(r=o.next()).done;)a.push(r.value)}catch(t){i={error:t}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(i)throw i.error}}return a}function o(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(i(arguments[e]));return t}var a=".",s={};function u(t){return"string"!=typeof t&&("value"in t&&"tree"in t&&"history"in t)}function c(t){return Object.keys(t)}function f(t,e,n){void 0===n&&(n=a);var r=d(t,n),i=d(e,n);return"string"==typeof i?"string"==typeof r&&i===r:"string"==typeof r?r in i:c(r).every(function(t){return t in i&&f(r[t],i[t])})}function h(t){try{return"string"==typeof t||"number"==typeof t?""+t:t.type}catch(t){throw new Error("Events must be strings or objects with a string event.type property.")}}function l(t){try{return"string"==typeof t||"number"==typeof t?""+t:"function"==typeof t?t.name:t.type}catch(t){throw new Error("Actions must be strings or objects with a string action.type property.")}}function p(t,e){try{return Array.isArray(t)?t:t.toString().split(e)}catch(e){throw new Error("'"+t+"' is not a valid state path.")}}function d(t,e){return u(t)?t.value:Array.isArray(t)?y(t):"string"==typeof t||u(t)?y(p(t,e)):t}function y(t){if(1===t.length)return t[0];for(var e={},n=e,r=0;r<t.length-1;r++)r===t.length-2?n[t[r]]=t[r+1]:(n[t[r]]={},n=n[t[r]]);return e}function v(t,e){var n={};return c(t).forEach(function(r,i){n[r]=e(t[r],r,t,i)}),n}function g(t,e,n){var r={};return c(t).forEach(function(i){var o=t[i];n(o)&&(r[i]=e(o,i,t))}),r}var m=function(t){return function(e){var n,i,o=e;try{for(var a=r(t),s=a.next();!s.done;s=a.next()){o=o[s.value]}}catch(t){n={error:t}}finally{try{s&&!s.done&&(i=a.return)&&i.call(a)}finally{if(n)throw n.error}}return o}};var S,x,b=function(t){return t?"string"==typeof t?[[t]]:N(c(t).map(function(e){var n=t[e];return"string"==typeof n||Object.keys(n).length?b(t[e]).map(function(t){return[e].concat(t)}):[[e]]})):[[]]};function N(t){var e;return(e=[]).concat.apply(e,o(t))}function w(t){return Array.isArray(t)?t:void 0===t?[]:[t]}!function(t){t.Start="xstate.start",t.Stop="xstate.stop",t.Raise="xstate.raise",t.Send="xstate.send",t.Cancel="xstate.cancel",t.NullEvent="",t.Assign="xstate.assign",t.After="xstate.after",t.DoneState="done.state",t.DoneInvoke="done.invoke",t.Log="xstate.log",t.Init="xstate.init",t.Invoke="xstate.invoke",t.ErrorExecution="error.execution",t.ErrorCommunication="error.communication"}(S||(S={})),function(t){t.Parent="#_parent",t.Internal="#_internal"}(x||(x={}));var E=function(){function t(t){this.actions=[],this.activities=s,this.meta={},this.events=[],this.value=t.value,this.context=t.context,this.historyValue=t.historyValue,this.history=t.history,this.actions=t.actions||[],this.activities=t.activities||s,this.meta=t.meta||{},this.events=t.events||[],Object.defineProperty(this,"tree",{value:t.tree,enumerable:!1})}return t.from=function(e,n){return e instanceof t?e.context!==n?new t({value:e.value,context:n,historyValue:e.historyValue,history:e.history,actions:[],activities:e.activities,meta:{},events:[],tree:e.tree}):e:new t({value:e,context:n,historyValue:void 0,history:void 0,actions:[],activities:void 0,meta:void 0,events:[]})},t.create=function(e){return new t(e)},t.inert=function(e,n){return e instanceof t?e.actions.length?new t({value:e.value,context:n,historyValue:e.historyValue,history:e.history,activities:e.activities,tree:e.tree}):e:t.from(e,n)},Object.defineProperty(t.prototype,"nextEvents",{get:function(){return this.tree?this.tree.nextEvents:[]},enumerable:!0,configurable:!0}),t.prototype.toStrings=function(t,e){var n=this;if(void 0===t&&(t=this.value),void 0===e&&(e="."),"string"==typeof t)return[t];var r=c(t);return r.concat.apply(r,o(r.map(function(r){return n.toStrings(t[r]).map(function(t){return r+e+t})})))},t.prototype.matches=function(t){return f(t,this.value)},Object.defineProperty(t.prototype,"changed",{get:function(){if(this.history)return!!this.actions.length||typeof this.history.value!=typeof this.value||("string"==typeof this.value?this.value!==this.history.value:function t(e,n){if(e===n)return!0;var r=c(e),i=c(n);return r.length===i.length&&r.every(function(r){return t(e[r],n[r])})}(this.value,this.history.value))},enumerable:!0,configurable:!0}),t}(),O=(S.Start,S.Stop,S.Raise),P=S.Send,j=S.Cancel,A=S.NullEvent,V=S.Assign,k=(S.After,S.DoneState,S.Log,S.Init,S.Invoke,S.ErrorExecution);function _(t){return"string"==typeof t||"number"==typeof t?{type:t}:t}function C(t,e){if(e){var n=e[t];if(n)return n}}function I(t,r){var i;if("string"==typeof t||"number"==typeof t){var o=C(t,r);i="function"==typeof o?{type:t,exec:o}:o||{type:t,exec:void 0}}else if("function"==typeof t)i={type:t.name,exec:t};else{if("function"==typeof(o=C(t.type,r)))i=e({},t,{exec:o});else if(o){var a=t.type,s=n(t,["type"]);i=e({type:a},o,s)}else i=t}return Object.defineProperty(i,"toString",{value:function(){return i.type},enumerable:!1,configurable:!0}),i}function R(t){var n=I(t);return e({id:"string"==typeof t?t:n.id},n,{type:n.type})}function T(t){return{type:O,event:t}}function J(t){var e=R(t);return{type:S.Start,activity:e,exec:void 0}}function D(t,e){var n=e?"#"+e:"";return S.After+"("+t+")"+n}function M(t,e){var n=S.DoneState+"."+t,r={type:n,data:e,toString:function(){return n}};return r}var F={resolved:!1},B=function(){function t(n,r,i){var o;void 0===i&&(i=F),this.stateNode=n,this._stateValue=r,this.nodes=r?"string"==typeof r?((o={})[r]=new t(n.getStateNode(r),void 0),o):v(r,function(e,r){return new t(n.getStateNode(r),e)}):{};var a=e({},F,i);this.isResolved=a.resolved}return Object.defineProperty(t.prototype,"done",{get:function(){var t=this;switch(this.stateNode.type){case"final":return!0;case"compound":return"final"===this.nodes[c(this.nodes)[0]].stateNode.type;case"parallel":return c(this.nodes).some(function(e){return t.nodes[e].done});default:return!1}},enumerable:!0,configurable:!0}),t.prototype.getDoneData=function(t,e){if(this.done&&"compound"===this.stateNode.type){var n=this.nodes[c(this.nodes)[0]];if(!n.stateNode.data)return;return function(t,e,n){return"function"==typeof t?t(e,n):c(t).reduce(function(r,i){var o=t[i];return r[i]="function"==typeof o?o(e,n):o,r},{})}(n.stateNode.data,t,e)}},Object.defineProperty(t.prototype,"atomicNodes",{get:function(){var t=this;return"atomic"===this.stateNode.type||"final"===this.stateNode.type?[this.stateNode]:N(c(this.value).map(function(e){return t.value[e].atomicNodes}))},enumerable:!0,configurable:!0}),t.prototype.getDoneEvents=function(t){var e=this;if(!t||!t.size)return[];if(t.has(this.stateNode)&&"final"===this.stateNode.type)return[M(this.stateNode.id,this.stateNode.data)];var n=N(c(this.nodes).map(function(n){return e.nodes[n].getDoneEvents(t)}));if("parallel"===this.stateNode.type){var r=c(this.nodes).every(function(t){return e.nodes[t].done});return n&&r?[M(this.stateNode.id)].concat(n):n}if(!this.done||!n.length)return n;var i=1===n.length?n[0].data:void 0;return[M(this.stateNode.id,i)].concat(n)},Object.defineProperty(t.prototype,"resolved",{get:function(){return new t(this.stateNode,this.stateNode.resolve(this.value),{resolved:!0})},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"paths",{get:function(){return b(this.value)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"absolute",{get:function(){var e=this,n=this._stateValue,r={},i=r;return this.stateNode.path.forEach(function(t,r){r===e.stateNode.path.length-1?i[t]=n:(i[t]={},i=i[t])}),new t(this.stateNode.machine,r)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"nextEvents",{get:function(){var t=this,e=this.stateNode.ownEvents,n=N(c(this.nodes).map(function(e){return t.nodes[e].nextEvents}));return o(new Set(n.concat(e)))},enumerable:!0,configurable:!0}),t.prototype.clone=function(){return new t(this.stateNode,this.value)},t.prototype.combine=function(t){var e,n=this;if(t.stateNode!==this.stateNode)throw new Error("Cannot combine distinct trees");if("compound"===this.stateNode.type){var r=void 0;if(c(this.nodes).length&&c(t.nodes).length){var i=c(this.nodes)[0];return(e={})[i]=this.nodes[i].combine(t.nodes[i]),r=e,(a=this.clone()).nodes=r,a}return r=Object.assign({},this.nodes,t.nodes),(a=this.clone()).nodes=r,a}if("parallel"===this.stateNode.type){var a,s=new Set(o(c(this.nodes),c(t.nodes))),u={};return s.forEach(function(e){n.nodes[e]&&t.nodes[e]?u[e]=n.nodes[e].combine(t.nodes[e]):u[e]=n.nodes[e]||t.nodes[e]}),(a=this.clone()).nodes=u,a}return this},Object.defineProperty(t.prototype,"value",{get:function(){if("atomic"===this.stateNode.type||"final"===this.stateNode.type)return{};if("parallel"===this.stateNode.type)return v(this.nodes,function(t){return t.value});if("compound"===this.stateNode.type){if(0===c(this.nodes).length)return{};var t=this.nodes[c(this.nodes)[0]].stateNode;return"atomic"===t.type||"final"===t.type?t.key:v(this.nodes,function(t){return t.value})}return{}},enumerable:!0,configurable:!0}),t.prototype.matches=function(t){return f(t,this.value)},t.prototype.getEntryExitStates=function(t,e){var n=this;if(t.stateNode!==this.stateNode)throw new Error("Cannot compare distinct trees");switch(this.stateNode.type){case"compound":var r={exit:[],entry:[]},i=c(this.nodes)[0],a=c(t.nodes)[0];return i!==a?(r.exit=t.nodes[a].getExitStates(),r.entry=this.nodes[i].getEntryStates()):r=this.nodes[i].getEntryExitStates(t.nodes[a],e),e&&e.has(this.stateNode)&&(r.exit.push(this.stateNode),r.entry.unshift(this.stateNode)),r;case"parallel":var s=c(this.nodes).map(function(r){return n.nodes[r].getEntryExitStates(t.nodes[r],e)}),u={exit:[],entry:[]};return s.forEach(function(t){u.exit=o(u.exit,t.exit),u.entry=o(u.entry,t.entry)}),e&&e.has(this.stateNode)&&(u.exit.push(this.stateNode),u.entry.unshift(this.stateNode)),u;case"atomic":default:return e&&e.has(this.stateNode)?{exit:[this.stateNode],entry:[this.stateNode]}:{exit:[],entry:[]}}},t.prototype.getEntryStates=function(){var t=this;return this.nodes?[this.stateNode].concat(N(c(this.nodes).map(function(e){return t.nodes[e].getEntryStates()}))):[this.stateNode]},t.prototype.getExitStates=function(){var t=this;return this.nodes?N(c(this.nodes).map(function(e){return t.nodes[e].getExitStates()})).concat(this.stateNode):[this.stateNode]},t}(),H=".",L="",z={},G=function(t){return"#"===t[0]},U=function(){return{guards:z}},X=!0,q=(function(){function t(n,r,i){void 0===r&&(r=U());var a=this;this._config=n,this.options=r,this.context=i,this.__cache={events:void 0,relativeValue:new Map,initialState:void 0},this.idMap={},this.key=n.key||n.id||"(machine)",this.parent=n.parent,this.machine=this.parent?this.parent.machine:this,this.path=this.parent?this.parent.path.concat(this.key):[],this.delimiter=n.delimiter||(this.parent?this.parent.delimiter:H),this.id=n.id||(this.machine?o([this.machine.key],this.path).join(this.delimiter):this.key),this.type=n.type||(n.parallel?"parallel":n.states&&c(n.states).length?"compound":n.history?"history":"atomic"),!X&&"parallel"in n&&console.warn('The "parallel" property is deprecated and will be removed in version 4.1. '+(n.parallel?"Replace with `type: 'parallel'`":"Use `type: '"+this.type+"'`")+" in the config for state node '"+this.id+"' instead."),this.initial=n.initial,this.order=n.order||-1,this.states=n.states?v(n.states,function(n,r,i,o){var s,u=new t(e({},n,{key:r,order:void 0===n.order?n.order:o,parent:a}));return Object.assign(a.idMap,e(((s={})[u.id]=u,s),u.idMap)),u}):z,this.history=!0===n.history?"shallow":n.history||!1,this.transient=!(!n.on||!n.on[L]),this.strict=!!n.strict,this.onEntry=w(n.onEntry).map(function(t){return I(t)}),this.onExit=w(n.onExit).map(function(t){return I(t)}),this.meta=n.meta,this.data="final"===this.type?n.data:void 0,this.invoke=w(n.invoke).map(function(t){return function(t,n){if("string"==typeof t)return e({id:t,src:t,type:S.Invoke},n);if(!("src"in t)){var r=t;return{type:S.Invoke,id:r.id,src:r}}return e({type:S.Invoke},t,{id:t.id||("string"==typeof t.src?t.src:"function"==typeof t.src?"promise":t.src.id)})}(t)}),this.activities=w(n.activities).concat(this.invoke).map(function(t){return a.resolveActivity(t)})}t.prototype.withConfig=function(n,r){var i=this.options,o=i.actions,a=i.activities,s=i.guards;return new t(this.definition,{actions:e({},o,n.actions),activities:e({},a,n.activities),guards:e({},s,n.guards)},r)},t.prototype.withContext=function(e){return new t(this.definition,this.options,e)},Object.defineProperty(t.prototype,"definition",{get:function(){return{id:this.id,key:this.key,type:this.type,initial:this.initial,history:this.history,states:v(this.states,function(t){return t.definition}),on:this.on,onEntry:this.onEntry,onExit:this.onExit,activities:this.activities||[],meta:this.meta,order:this.order||-1,data:this.data}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"config",{get:function(){var t=this._config;t.parent;return n(t,["parent"])},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"on",{get:function(){return this.formatTransitions()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"transitions",{get:function(){var t=this;return N(c(this.on).map(function(e){return t.on[e]}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"after",{get:function(){var t=this,n=this.config.after;if(!n)return[];if(Array.isArray(n))return n.map(function(n){return e({event:D(n.delay,t.id)},n,{actions:w(n.actions).map(function(t){return I(t)})})});var r=N(c(n).map(function(r){var i=n[r],o=+r,a=D(o,t.id);return"string"==typeof i?[{target:i,delay:o,event:a,actions:[]}]:w(i).map(function(t){return e({event:a,delay:o},t,{actions:w(t.actions).map(function(t){return I(t)})})})}));return r.sort(function(t,e){return t.delay-e.delay}),r},enumerable:!0,configurable:!0}),t.prototype.getStateNodes=function(t){var e,n=this;if(!t)return[];var r=t instanceof E?t.value:d(t,this.delimiter);if("string"==typeof r){var i=this.getStateNode(r).initial;return i?this.getStateNodes(((e={})[r]=i,e)):[this.states[r]]}var o=c(r);return o.map(function(t){return n.getStateNode(t)}).concat(o.reduce(function(t,e){var i=n.getStateNode(e).getStateNodes(r[e]);return t.concat(i)},[]))},t.prototype.handles=function(t){var e=h(t);return-1!==this.events.indexOf(e)},t.prototype.transitionLeafNode=function(t,e,n,r){var i=this.getStateNode(t).next(e,n,r);if(!i.tree){var o=this.next(e,n,r),a=o.reentryStates,s=o.actions;return{tree:o.tree,source:e,reentryStates:a,actions:s}}return i},t.prototype.transitionCompoundNode=function(t,e,n,r){var i=c(t),o=this.getStateNode(i[0])._transition(t[i[0]],e,n,r);if(!o.tree){var a=this.next(e,n,r),s=a.reentryStates,u=a.actions;return{tree:a.tree,source:e,reentryStates:s,actions:u}}return o},t.prototype.transitionParallelNode=function(t,e,n,r){var i=this,a={};if(c(t).forEach(function(o){var s=t[o];if(s){var u=i.getStateNode(o)._transition(s,e,n,r);u.tree,a[o]=u}}),!c(a).some(function(t){return void 0!==a[t].tree})){var s=this.next(e,n,r),u=s.reentryStates,h=s.actions;return{tree:s.tree,source:e,reentryStates:u,actions:h}}var l=c(a).map(function(t){return a[t].tree}).filter(function(t){return void 0!==t}).reduce(function(t,e){return t.combine(e)});return 1!==l.paths.length||f(d(this.path,this.delimiter),l.value)?{tree:c(a).map(function(t){var n=a[t],r=m(i.path)(n.tree?n.tree.value:e.value||e.value)[t];return new B(i.getStateNode(t),r).absolute}).reduce(function(t,e){return t.combine(e)}),source:e,reentryStates:c(a).reduce(function(t,e){var n=a[e],r=n.tree,i=n.reentryStates;return r&&i?new Set(o(Array.from(t),Array.from(i))):t},new Set),actions:N(c(a).map(function(t){return a[t].actions}))}:{tree:l,source:e,reentryStates:c(a).map(function(t){return a[t].reentryStates}).reduce(function(t,e){return new Set(o(Array.from(t||[]),Array.from(e||[])))},new Set),actions:N(c(a).map(function(t){return a[t].actions}))}},t.prototype._transition=function(t,e,n,r){return"string"==typeof t?this.transitionLeafNode(t,e,n,r):1===c(t).length?this.transitionCompoundNode(t,e,n,r):this.transitionParallelNode(t,e,n,r)},t.prototype.next=function(t,e,n){var i,a,s=this,u=e.type,c=this.on[u],h=this.transient?[{type:A}]:[];if(!c||!c.length)return{tree:void 0,source:t,reentryStates:void 0,actions:h};var l,p=[];try{for(var y=r(c),v=y.next();!v.done;v=y.next()){var g=v.value,S=g,x=S.cond,b=S.in,E=n||z,O=!b||("string"==typeof b&&G(b)?t.matches(d(this.getStateNodeById(b).path,this.delimiter)):f(d(b,this.delimiter),m(this.path.slice(0,-2))(t.value)));if((!x||this.evaluateGuard(x,E,e,t.value))&&O){p=w(g.target),h.push.apply(h,o(w(g.actions))),l=g;break}}}catch(t){i={error:t}}finally{try{v&&!v.done&&(a=y.return)&&a.call(y)}finally{if(i)throw i.error}}if(l&&0===p.length)return{tree:t.value?this.machine.getStateTree(t.value):void 0,source:t,reentryStates:void 0,actions:h};if(!l&&0===p.length)return{tree:void 0,source:t,reentryStates:void 0,actions:h};var P=N(p.map(function(e){return s.getRelativeStateNodes(e,t.historyValue)})),j=!!l.internal?[]:N(P.map(function(t){return s.nodesFromChild(t)}));return{tree:P.map(function(t){return t.tree}).reduce(function(t,e){return t.combine(e)}),source:t,reentryStates:new Set(j),actions:h}},Object.defineProperty(t.prototype,"tree",{get:function(){var t=d(this.path,this.delimiter);return new B(this.machine,t)},enumerable:!0,configurable:!0}),t.prototype.nodesFromChild=function(t){if(t.escapes(this))return[];for(var e=[],n=t;n&&n!==this;)e.push(n),n=n.parent;return e.push(this),e},t.prototype.getStateTree=function(t){return new B(this,t)},t.prototype.escapes=function(t){if(this===t)return!1;for(var e=this.parent;e;){if(e===t)return!1;e=e.parent}return!0},t.prototype.evaluateGuard=function(t,e,n,r){var i,o=this.machine.options.guards;if("string"==typeof t){if(!o||!o[t])throw new Error("Condition '"+t+"' is not implemented on machine '"+this.machine.id+"'.");i=o[t]}else i=t;return i(e,n,r)},Object.defineProperty(t.prototype,"delays",{get:function(){var t=this;return Array.from(new Set(this.transitions.map(function(t){return t.delay}).filter(function(t){return void 0!==t}))).map(function(e){return{id:t.id,delay:e}})},enumerable:!0,configurable:!0}),t.prototype.getActions=function(t,e){var n=this,r=t.tree?t.tree.resolved.getEntryExitStates(this.getStateTree(e.value),t.reentryStates?t.reentryStates:void 0):{entry:[],exit:[]},i=t.tree?t.tree.getDoneEvents(new Set(r.entry)):[];t.source||(r.exit=[]);var a={entry:N(Array.from(new Set(r.entry)).map(function(t){return o(t.onEntry,t.activities.map(function(t){return J(t)}),t.delays.map(function(t){var e,n,r=t.delay,i=t.id;return e=D(r,i),{to:(n={delay:r})?n.to:void 0,type:P,event:_(e),delay:n?n.delay:void 0,id:n&&void 0!==n.id?n.id:h(e)}}))})).concat(i.map(T)),exit:N(Array.from(new Set(r.exit)).map(function(t){return o(t.onExit,t.activities.map(function(t){return function(t){var e=R(t);return{type:S.Stop,activity:e,exec:void 0}}(t)}),t.delays.map(function(t){var e,n=t.delay,r=t.id;return e=D(n,r),{type:j,sendId:e}}))}))};return a.exit.concat(t.actions).concat(a.entry).map(function(t){return n.resolveAction(t)})},t.prototype.resolveAction=function(t){return I(t,this.machine.options.actions)},t.prototype.resolveActivity=function(t){return R(t)},t.prototype.getActivities=function(t,n){if(!t)return z;var r=e({},n);return Array.from(t.exit).forEach(function(t){t.activities.forEach(function(t){r[t.type]=!1})}),Array.from(t.entry).forEach(function(t){t.activities.forEach(function(t){r[t.type]=!0})}),r},t.prototype.transition=function(t,n,r){var i="string"==typeof t?this.resolve(y(this.getResolvedPath(t))):t instanceof E?t:this.resolve(t),o=r||(t instanceof E?t.context:this.machine.context),a=_(n),s=a.type;if(this.strict&&-1===this.events.indexOf(s))throw new Error("Machine '"+this.id+"' does not accept event '"+s+"'");var u=E.from(i,o),c=this._transition(u.value,u,a,o),f=e({},c,{tree:c.tree?c.tree.resolved:void 0});return this.resolveTransition(f,u,a)},t.prototype.resolveTransition=function(e,n,r){var i,a=e.tree?e.tree.value:void 0,s=n.historyValue?n.historyValue:e.source?this.machine.historyValue(n.value):void 0;if(!X&&e.tree)try{this.ensureValidPaths(e.tree.paths)}catch(t){throw new Error("Event '"+(r?r.type:"none")+"' leads to an invalid configuration: "+t.message)}var u=this.getActions(e,n),c=e.tree?e.tree.getEntryExitStates(this.getStateTree(n.value)):{entry:[],exit:[]},f=e.tree?this.getActivities({entry:new Set(c.entry),exit:new Set(c.exit)},n.activities):{},h=u.filter(function(t){return t.type===O||t.type===A}),l=u.filter(function(t){return t.type!==O&&t.type!==A&&t.type!==V}),p=u.filter(function(t){return t.type===V}),d=t.updateContext(n.context,r,p),y=a?this.getStateNodes(a):[];y.some(function(t){return t.transient})&&h.push({type:A});var v,g,m=o([this],y).reduce(function(t,e){return void 0!==e.meta&&(t[e.id]=e.meta),t},{}),S=a?new E({value:a,context:d,historyValue:s?t.updateHistoryValue(s,a):void 0,history:e.source?n:void 0,actions:(v=l,g=this.options.actions,v?(Array.isArray(v)?v:[v]).map(function(t){return I(t,g)}):[]),activities:f,meta:m,events:h,tree:e.tree}):void 0;if(!S)return E.inert(n,d);n.history&&delete n.history.history;for(var x=S;h.length;){var b=x.actions,N=h.shift();(i=(x=this.transition(x,N.type===A?L:N.event,x.context)).actions).unshift.apply(i,o(b))}return x},t.updateContext=function(t,e,n){return t?n.reduce(function(t,n){var r=n.assignment,i={};return"function"==typeof r?i=r(t,e||{type:S.Init}):c(r).forEach(function(n){var o=r[n];i[n]="function"==typeof o?o(t,e):o}),Object.assign({},t,i)},t):t},t.prototype.ensureValidPaths=function(t){var e,n,i=this,o=new Map,a=N(t.map(function(t){return i.getRelativeStateNodes(t)}));try{t:for(var s=r(a),u=s.next();!u.done;u=s.next())for(var c=u.value,f=c;f.parent;){if(o.has(f.parent)){if("parallel"===f.parent.type)continue t;throw new Error("State node '"+c.id+"' shares parent '"+f.parent.id+"' with state node '"+o.get(f.parent).map(function(t){return t.id})+"'")}o.get(f.parent)?o.get(f.parent).push(c):o.set(f.parent,[c]),f=f.parent}}catch(t){e={error:t}}finally{try{u&&!u.done&&(n=s.return)&&n.call(s)}finally{if(e)throw e.error}}},t.prototype.getStateNode=function(t){if(G(t))return this.machine.getStateNodeById(t);if(!this.states)throw new Error("Unable to retrieve child state '"+t+"' from '"+this.id+"'; no child states exist.");var e=this.states[t];if(!e)throw new Error("Child state '"+t+"' does not exist on '"+this.id+"'");return e},t.prototype.getStateNodeById=function(t){var e=G(t)?t.slice("#".length):t;if(e===this.id)return this;var n=this.machine.idMap[e];if(!n)throw new Error("Substate '#"+e+"' does not exist on '"+this.id+"'");return n},t.prototype.getStateNodeByPath=function(t){for(var e=p(t,this.delimiter).slice(),n=this;e.length;){var r=e.shift();n=n.getStateNode(r)}return n},t.prototype.resolve=function(t){var e,n=this;if(!t)return this.initialStateValue||z;switch(this.type){case"parallel":return v(this.initialStateValue,function(e,r){return e?n.getStateNode(r).resolve(t[r]||e):z});case"compound":if("string"==typeof t){var r=this.getStateNode(t);return"parallel"===r.type||"compound"===r.type?((e={})[t]=r.initialStateValue,e):t}return c(t).length?v(t,function(t,e){return t?n.getStateNode(e).resolve(t):z}):this.initialStateValue||{};default:return t||z}},Object.defineProperty(t.prototype,"resolvedStateValue",{get:function(){var t,e,n=this.key;return"parallel"===this.type?((t={})[n]=g(this.states,function(t){return t.resolvedStateValue[t.key]},function(t){return!("history"===t.type)}),t):this.initial?((e={})[n]=this.states[this.initial].resolvedStateValue,e):n},enumerable:!0,configurable:!0}),t.prototype.getResolvedPath=function(t){if(G(t)){var e=this.machine.idMap[t.slice("#".length)];if(!e)throw new Error("Unable to find state node '"+t+"'");return e.path}return p(t,this.delimiter)},Object.defineProperty(t.prototype,"initialStateValue",{get:function(){if(this.__cache.initialState)return this.__cache.initialState;var t="parallel"===this.type?g(this.states,function(t){return t.initialStateValue||z},function(t){return!("history"===t.type)}):"string"==typeof this.resolvedStateValue?void 0:this.resolvedStateValue[this.key];return this.__cache.initialState=t,this.__cache.initialState},enumerable:!0,configurable:!0}),t.prototype.getInitialState=function(e,n){void 0===n&&(n=this.machine.context);var r={},i=[];this.getStateNodes(e).forEach(function(t){t.onEntry&&i.push.apply(i,o(t.onEntry)),t.activities&&t.activities.forEach(function(t){r[h(t)]=!0,i.push(J(t))})});var a=i.filter(function(t){return"object"==typeof t&&t.type===V}),s=t.updateContext(n,void 0,a);return new E({value:e,context:s,activities:r})},Object.defineProperty(t.prototype,"initialState",{get:function(){var t=this.initialStateValue;if(!t)throw new Error("Cannot retrieve initial state from simple state '"+this.id+"'.");var e=this.getInitialState(t);return this.resolveTransition({tree:this.getStateTree(t),source:void 0,reentryStates:new Set(this.getStateNodes(t)),actions:[]},e,void 0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"target",{get:function(){var t;if("history"===this.type){var e=this.config;t=e.target&&"string"==typeof e.target&&G(e.target)?y(this.machine.getStateNodeById(e.target).path.slice(this.path.length-1)):e.target}return t},enumerable:!0,configurable:!0}),t.prototype.getStates=function(t){var e=this;if("string"==typeof t)return[this.states[t]];var n=[];return c(t).forEach(function(r){n.push.apply(n,o(e.states[r].getStates(t[r])))}),n},t.prototype.getRelativeStateNodes=function(t,e,n){if(void 0===n&&(n=!0),"string"==typeof t&&G(t)){var r=this.getStateNodeById(t);return n?"history"===r.type?r.resolveHistory(e):r.initialStateNodes:[r]}var i=p(t,this.delimiter),o=(this.parent||this).getFromRelativePath(i,e);return n?N(o.map(function(t){return t.initialStateNodes})):o},Object.defineProperty(t.prototype,"initialStateNodes",{get:function(){var t=this;if("atomic"===this.type||"final"===this.type)return[this];if("compound"===this.type&&!this.initial)return X||console.warn("Compound state node '"+this.id+"' has no initial state."),[this];var e=this.initialStateValue;return N(b(e).map(function(e){return t.getFromRelativePath(e)}))},enumerable:!0,configurable:!0}),t.prototype.getFromRelativePath=function(t,e){if(!t.length)return[this];var n=i(t),r=n[0],o=n.slice(1);if(!this.states)throw new Error("Cannot retrieve subPath '"+r+"' from node with no states");var a=this.getStateNode(r);if("history"===a.type)return a.resolveHistory(e);if(!this.states[r])throw new Error("Child state '"+r+"' does not exist on '"+this.id+"'");return this.states[r].getFromRelativePath(o,e)},t.updateHistoryValue=function(t,e){return{current:e,states:function t(e,n){return v(e.states,function(e,r){if(e){var i=("string"==typeof n?void 0:n[r])||(e?e.current:void 0);if(i)return{current:i,states:t(e,i)}}})}(t,e)}},t.prototype.historyValue=function(t){if(c(this.states).length)return{current:t||this.initialStateValue,states:g(this.states,function(e,n){if(!t)return e.historyValue();var r="string"==typeof t?void 0:t[n];return e.historyValue(r||e.initialStateValue)},function(t){return!t.history})}},t.prototype.resolveHistory=function(t){var e=this;if("history"!==this.type)return[this];var n=this.parent;if(!t)return this.target?N(b(this.target).map(function(t){return n.getFromRelativePath(t)})):this.parent.initialStateNodes;var i,o,a=(i=n.path,o="states",function(t){var e,n,a=t;try{for(var s=r(i),u=s.next();!u.done;u=s.next()){var c=u.value;a=a[o][c]}}catch(t){e={error:t}}finally{try{u&&!u.done&&(n=s.return)&&n.call(s)}finally{if(e)throw e.error}}return a})(t).current;return"string"==typeof a?[n.getStateNode(a)]:N(b(a).map(function(t){return"deep"===e.history?n.getFromRelativePath(t):[n.states[t[0]]]}))},Object.defineProperty(t.prototype,"stateIds",{get:function(){var t=this,e=N(c(this.states).map(function(e){return t.states[e].stateIds}));return[this.id].concat(e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"events",{get:function(){if(this.__cache.events)return this.__cache.events;var t=this.states,e=new Set(this.ownEvents);return t&&c(t).forEach(function(n){var i,o,a=t[n];if(a.states)try{for(var s=r(a.events),u=s.next();!u.done;u=s.next()){var c=u.value;e.add(""+c)}}catch(t){i={error:t}}finally{try{u&&!u.done&&(o=s.return)&&o.call(s)}finally{if(i)throw i.error}}}),this.__cache.events=Array.from(e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"ownEvents",{get:function(){var t=this,e=new Set(c(this.on).filter(function(e){return t.on[e].some(function(t){return!(!t.target&&!t.actions.length&&t.internal)})}));return Array.from(e)},enumerable:!0,configurable:!0}),t.prototype.formatTransition=function(t,n,r){var i=this,o=!!n&&n.internal;if(void 0===t||""===t)return e({},n,{actions:n?w(n.actions).map(function(t){return I(t)}):[],target:void 0,internal:!n||(void 0===n.internal||n.internal),event:r});var a=w(t).map(function(t){var e="string"==typeof t&&t[0]===i.delimiter;return o=o||e,e&&!i.parent?t.slice(1):e?i.key+t:""+t});return e({},n,{actions:n?w(n.actions).map(function(t){return I(t)}):[],target:a,internal:o,event:r})},t.prototype.formatTransitions=function(){var t,n=this,r=this.config.on||z,i=this.config.onDone?((t={})[""+M(this.id)]=this.config.onDone,t):void 0,o=this.invoke.reduce(function(t,e){var n,r,i,o;return e.onDone&&(t[(n=e.id,i=S.DoneInvoke+"."+n,o={type:i,data:r,toString:function(){return i}},o)]=e.onDone),e.onError&&(t[k]=e.onError),t},{}),a=this.after,s=v(e({},r,i,o),function(t,e){return void 0===t?[{target:void 0,event:e,actions:[],internal:!0}]:Array.isArray(t)?t.map(function(t){return n.formatTransition(t.target,t,e)}):"string"==typeof t?[n.formatTransition([t],void 0,e)]:(X||c(t).forEach(function(t){if(-1===["target","actions","internal","in","cond"].indexOf(t))throw new Error("State object mapping of transitions is deprecated. Check the config for event '"+e+"' on state '"+n.id+"'.")}),[n.formatTransition(t.target,t,e)])});return a.forEach(function(t){s[t.event]=s[t.event]||[],s[t.event].push(t)}),s}}(),{});function K(t,e){return N(t.definition.on[e].map(function(n){var r=n.target?[].concat(n.target):void 0;return r?r.map(function(r){try{var i=r?t.getRelativeStateNodes(r,void 0,!1)[0]:t;return{source:t,target:i,event:e,actions:n.actions?n.actions.map(l):[],cond:n.cond,transition:n}}catch(e){return void console.warn("Target '"+r+"' not found on '"+t.id+"'")}}).filter(function(t){return void 0!==t}):[{source:t,target:t,event:e,actions:n.actions?n.actions.map(l):[],cond:n.cond,transition:n}]}))}function Q(t,e){var n={},i=t.events;return function o(a){var s,u,c=JSON.stringify(a);if(!n[c]){n[c]={};try{for(var f=r(i),h=f.next();!h.done;h=f.next()){var l=h.value,p=t.transition(a,l,e);n[c][l]={state:p.value},o(p.value)}}catch(t){s={error:t}}finally{try{h&&!h.done&&(u=f.return)&&u.call(f)}finally{if(s)throw s.error}}}}(t.initialState.value),n}function W(t){if("string"==typeof t||"number"==typeof t)return""+t;var e=t.type,r=n(t,["type"]);return e+" | "+JSON.stringify(r)}function Y(t){var e=t.value,n=t.context;return JSON.stringify(e)+" | "+JSON.stringify(n)}function Z(t,e){var n=e.events,i=e.filter,o={},a=N(t.events.map(function(t){return n[t]||[t]}));return function e(n){var s,u,c=Y(n);if(!o[c]){o[c]={};try{for(var f=r(a),h=f.next();!h.done;h=f.next()){var l=h.value,p=t.transition(n,l);i&&!i(p)||(o[c][W(l)]={value:p.value,context:p.context},e(p))}}catch(t){s={error:t}}finally{try{h&&!h.done&&(u=f.return)&&u.call(f)}finally{if(s)throw s.error}}}}(t.initialState),o}function $(t,e){var n;if(!t.states)return q;var i=Q(t,e),a=((n={})[JSON.stringify(t.initialState.value)]=[],n),s=new Set;return function e(n){var u,f,h,l,p=JSON.stringify(n);s.add(p);var y=i[p];try{for(var v=r(c(y)),g=v.next();!g.done;g=v.next()){var m=g.value;if(N=y[m].state){var S=JSON.stringify(d(N,t.delimiter));(!a[S]||a[S].length>a[p].length+1)&&(a[S]=o(a[p]||[],[{state:n,event:m}]))}}}catch(t){u={error:t}}finally{try{g&&!g.done&&(f=v.return)&&f.call(v)}finally{if(u)throw u.error}}try{for(var x=r(c(y)),b=x.next();!b.done;b=x.next()){var N;(N=y[b.value].state)&&(S=JSON.stringify(N),s.has(S)||e(N))}}catch(t){h={error:t}}finally{try{b&&!b.done&&(l=x.return)&&l.call(x)}finally{if(h)throw h.error}}return a}(t.initialState.value),a}function tt(t,e){if(!t.states)return q;var n=Q(t,e),i=new Set,a=[],s={};var u=JSON.stringify(t.initialState.value);return c(n).forEach(function(t){!function t(e,u){var f,h;if(i.add(e),e===u)s[u]=s[u]||[],s[u].push(o(a));else try{for(var l=r(c(n[e])),p=l.next();!p.done;p=l.next()){var d=p.value,y=n[e][d].state;if(y){var v=JSON.stringify(y);i.has(v)||(a.push({state:JSON.parse(e),event:d}),t(v,u))}}}catch(t){f={error:t}}finally{try{p&&!p.done&&(h=l.return)&&h.call(l)}finally{if(f)throw f.error}}a.pop(),i.delete(e)}(u,t)}),s}t.getNodes=function t(e){var n=e.states;return c(n).reduce(function(e,r){var i=n[r],a=t(n[r]);return e.push.apply(e,o([i],a)),e},[])},t.getEventEdges=K,t.getEdges=function t(e,n){var r=(n||{}).depth,i=void 0===r?null:r,a=[];return e.states&&null===i?c(e.states).forEach(function(n){a.push.apply(a,o(t(e.states[n])))}):i&&i>0&&c(e.states).forEach(function(n){a.push.apply(a,o(t(e.states[n],{depth:i-1})))}),c(e.on).forEach(function(t){a.push.apply(a,o(K(e,t)))}),a},t.getAdjacencyMap=Q,t.deserializeStateString=function(t){var e=i(t.split(" | "),2),n=e[0],r=e[1];return{value:JSON.parse(n),context:JSON.parse(r)}},t.serializeState=Y,t.getValueAdjacencyMap=Z,t.getShortestValuePaths=function(t,e){if(!t.states)return q;var n=Z(t,e),i={},a=new Set;return function t(e){var s,u,f,h,l=Y(e);a.add(l);var p=n[l];try{for(var d=r(c(p)),y=d.next();!y.done;y=d.next()){var v=y.value,g=p[v],m=g.value,S=g.context;if(m){var x=Y(P=E.from(m,S));(!i[x]||i[x].length>i[l].length+1)&&(i[x]=o(i[l]||[],[{state:m,event:v}]))}}}catch(t){s={error:t}}finally{try{y&&!y.done&&(u=d.return)&&u.call(d)}finally{if(s)throw s.error}}try{for(var b=r(c(p)),N=b.next();!N.done;N=b.next()){var w=p[N.value],O=(m=w.value,w.context);if(m){var P=E.from(m,O);x=Y(E.from(m,O)),a.has(x)||t(P)}}}catch(t){f={error:t}}finally{try{N&&!N.done&&(h=b.return)&&h.call(b)}finally{if(f)throw f.error}}return i}(t.initialState),i},t.getShortestPaths=$,t.getShortestPathsAsArray=function(t,e){var n=$(t,e);return c(n).map(function(t){return{state:JSON.parse(t),path:n[t]}})},t.getSimplePaths=tt,t.getSimplePathsAsArray=function(t,e){var n=tt(t,e);return c(n).map(function(t){return{state:JSON.parse(t),paths:n[t]}})},Object.defineProperty(t,"__esModule",{value:!0})});
